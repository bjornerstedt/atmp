---
title: "ATMP analysis"
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(knitr)
library(flextable)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(dplyr.summarise.inform = FALSE)
options(knitr.kable.NA = '') # Suppress printing of NA in kable
# Standard theme for document 
theme_set(theme_bw()) 

set_flextable_defaults(
align = "center",
digits = 2
# theme_fun = theme_zebra
  )

doShiny = TRUE

source("atmp.R")

indata = open_indata("Example_A.xlsx")

```

## Treatment table

```{r}
indata$treatment_table %>% 
  with_titles( indata$treatment_description) %>% 
  flextable_output() %>% 
  colformat_double(j = c(1,6), digits = 0) 
```

## Payment table

```{r, eval=TRUE}
indata$contract_table %>% 
  with_titles( indata$contract_description) %>% 
  flextable_output()  %>% 
  colformat_double(j = c(1,5,6,7), digits = 0) 
```

# Analysis

```{r, knitr.kable.na = ' '}
rubriker = c(Treatment = "name", Payment = "contract")
 contract_analysis(indata, show_details = TRUE) %>% 
   select(-plan) %>% rename(any_of(rubriker)) %>% 
  flextable_output() 
```

### Simple result

```{r, knitr.kable.na = ' '}
rubriker = c(Behandling = "name", Payment = "contract")
 contract_analysis(indata) %>% rename(any_of(rubriker)) %>% 
  flextable_output() 
```

## Input table

```{r}
mod_table = read_csv("
table_name, row_name, column_name, value 
global_table,  firm_discount, value, 0.03
global_table,  firm_discount, value, 0.10
treatment_table,  ATMP, p_HU, 0.00
treatment_table,  ATMP, p_HU, 0.01
treatment_table,  ATMP, p_HU, 0.05
contract_table,  ATMP company, contract_length, 1.00
contract_table,  ATMP company, contract_length, 5.00
contract_table,  ATMP company, contract_length, 10.00
")

mod_table %>% 
  flextable_output() 
```

# Results

```{r}
compare_with_variations(indata, mod_table ) %>% 
  rename(Hazard = p_HU, Length = contract_length, Jämförelse = Treatments, Costdiff. = Cost, QALYdiff. = QALY)  %>% rename(firm_discount = value) %>% 
  select(-Jämförelse) %>% 
   flextable_output()  
```


# Payments over time

```{r}
df =  contract_analysis(indata, over_time = TRUE) 

df %>% rename(Contract = contract) %>% 
  ggplot() + 
  aes(time, Cost, fill = Contract) + 
  geom_col()  + facet_grid(rows = vars(name)) +
  labs(x = "")
```


